<div
  *ngIf="
    validationTriggered &&
    (!isDateRangeValid() ||
      !areUrlsValid() ||
      !areMetricsValid() ||
      this.error())
  "
>
  <upd-alert [type]="'danger'" [dismissible]="false" [selfClosing]="false">
    <p class="align-top pe-1">
      <span class="material-icons align-top pe-1" aria-hidden="true"
        >error</span
      >
      {{'Oops' | translate}}
    </p>
    <p class="align-top pe-1">{{'please-fix-following' | translate}}</p>
    <ul>
      <li *ngIf="!isDateRangeValid()">
        <a class="alert-link" (click)="scrollToAnchor('select-date')"
          ><span [translate]="'alert-date'"></span
        ></a>
      </li>
      <li *ngIf="!areUrlsValid()">
        <a class="alert-link" (click)="scrollToAnchor('select-url')"
          ><span [translate]="'alert-url'"></span>
        </a>
      </li>
      <li class="alert-link" *ngIf="!areMetricsValid()">
        <a (click)="scrollToAnchor('select-metric')"
          ><span [translate]="'alert-metric'"></span>
        </a>
      </li>
      <li *ngIf="this.error()">
        <span [translate]="this.error() || 'error'"></span>
      </li>
    </ul>
  </upd-alert>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
      <p translate="custom-report-desc"></p>
    </div>
  </div>
</div>  
   

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
      <h3 class="mb-2 h5 pt-2 pb-2 me-2 card-tooltip">
        <span placement="top" ngbTooltip="{{'tooltip-select-granularity' | translate}}">{{
          'select-granularity' | translate
        }}</span>
        </h3>

      <upd-dropdown
        id="granularity"
        [label]="'Select' | translate"
        [options]="granularityOptions"
        [selectedOption]="selectedGranularityOption"
        (selectOption)="selectGranularity($event.value); resetValidation()"
        [autoDisplayFirst]="true"
      >
      </upd-dropdown>
    </div>
  </div>
</div>

<ng-container *ngIf="showCopyAlert">
  <upd-alert position="top" [selfClosing]="true">{{'Copied successfully!' | translate}}</upd-alert>
</ng-container>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
      <!-- <div *ngIf="(validationTriggered && !isDateRangeValid()) || this.error()">
        <upd-alert
          [type]="'danger'"
          [dismissible]="false"
          [selfClosing]="false"
          id="dateError"
        >
          <span class="material-icons align-top pe-1" aria-hidden="true"
            >error</span
          >
          <span [translate]="'alert-date'"></span>
          <span
            *ngIf="this.error()"
            [translate]="this.error() || 'error'"
          ></span>
        </upd-alert>
      </div> -->

      <h3 class="mb-2 h5 pt-2 pb-2 card-tooltip" id="select-date">
        <span placement="top" ngbTooltip="{{'tooltip-select-date' | translate}}">{{
          'select-date' | translate
        }}</span>
        <span class="required-star"></span>
      </h3>

      <upd-calendar
        #calendar
        [showAction]="true"
        [showPreset]="true"
        [calendarDates]="stateCalendarDates"
        (dateChange)="handleDateChange($event); resetValidation()"
        [granularity]="selectedGranularity()"
        [required]="false"
        [dateFormat]="calendarDateFormat()"
        [invalid]="validationTriggered && !isDateRangeValid()"
      ></upd-calendar>
    </div>
  </div>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
      <!-- <div *ngIf="validationTriggered && !areUrlsValid()">
        <upd-alert
          [type]="'danger'"
          [dismissible]="false"
          [selfClosing]="false"
        >
          <span class="material-icons align-top pe-1" aria-hidden="true"
            >error</span
          >
          <span [translate]="'alert-url'"></span>
        </upd-alert>
      </div> -->

      <div
        [title]="'Validation Results'"
        *ngIf="invalidUrls().length > 0 || reportUrls().length > 0"
      >
        <div *ngIf="reportUrls().length > 0 && newUrls().length > 0">
          <upd-alert
            [type]="'success'"
            position="static"
            [dismissible]="true"
            [selfClosing]="true"
          >
            <span class="material-icons align-top pe-1" aria-hidden="true"
              >check</span
            >
            <span>{{'success-urls' | translate}}</span>
            <ol>
              <li *ngFor="let url of newUrls()">{{ url }}</li>
            </ol>
          </upd-alert>
        </div>
        <div *ngIf="invalidUrls().length > 0">
          <upd-alert
            [type]="'danger'"
            [dismissible]="false"
            [selfClosing]="false"
            position="static"
          >
            <span class="material-icons align-top pe-1" aria-hidden="true"
              >error</span
            >
            <span>{{'invalid-urls' | translate}}</span>
            <ol>
              <li *ngFor="let url of invalidUrls()">{{ url }}</li>
            </ol>
          </upd-alert>
        </div>
      </div>

      <div class="row">
        <div class="col guidance-modal">
          <h3 class="mb-2 h5 pt-2 pb-2" id="select-url">
            {{ 'select-url' | translate }}
            <span class="required-star"></span>
          </h3>
          <upd-modal id="add-pages-modal" [modalTitle]="'select-url'" modalContent="{{'select-pages-modal' | translate}}"> </upd-modal>
        </div>
      </div> 
      <div class="card add-pages-card"
      [ngClass]="{'card-invalid': validationTriggered && !areUrlsValid()}">
        <p-tabView styleClass="tabview-custom">
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>{{ 'Bulk Pages' | translate }}</span>
            </ng-template>
            <span class="p-float-label mt-3">
              <textarea
                pInputTextarea
                #urlTextarea
                rows="5"
                id="float-input"
                class="w-100"
              ></textarea>
              <label for="float-input"
                >{{'Enter URLs' | translate}}</label
              >
            </span>
          </p-tabPanel>
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>{{ 'Pages' | translate }}</span>
            </ng-template>
            <upd-data-table
              #dataTable
              id="pages-home-"
              [data]="pages()"
              [cols]="columns()"
              [displayRows]="5"
              [loading]="selectionData() === null"
              placeholderText="dt_search_keyword_url"
              [searchFields]="searchFields()"
              [exports]="false"
              [checkboxes]="true"
              (pageSelectionChanged)="selectPages($event)"
              [ngClass]="'pages-home'"
            >
            </upd-data-table>
          </p-tabPanel>
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>{{ 'tasks' | translate }}</span>
            </ng-template>
            <upd-data-table
              #tasksTable
              id="tasks-list-"
              [data]="tasks()"
              [cols]="taskColumns()"
              [displayRows]="5"
              [loading]="selectionData() === null"
              [exports]="false"
              [checkboxes]="true"
              (pageSelectionChanged)="selectTasks($event)"
              [ngClass]="'tasks-list'"
            >
            </upd-data-table>
          </p-tabPanel>
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>{{ 'ux_projects' | translate }}</span>
            </ng-template>
            <upd-data-table
              #projectsTable
              id="projects-list-"
              [data]="projects()"
              [cols]="taskColumns()"
              [displayRows]="5"
              [loading]="selectionData() === null"
              [exports]="false"
              [checkboxes]="true"
              (pageSelectionChanged)="selectProjects($event)"
              [ngClass]="'projects-list'"
            >
            </upd-data-table>
          </p-tabPanel>
        </p-tabView>

        <button
          class="btn btn-outline-primary"
          [translate]="'Add pages'"
          (click)="
            addPages(urlTextarea.value);
            resetTableSelection();
            resetValidation()
          "
        >
        </button>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid my-4 gx-0" *ngIf="reportUrls().length > 0">
  <div class="row">
    <div class="col">
      <!--   ACCORDION IS DEPRECATED   -->
      <upd-accordion
        #urlsAdded
        [styleClass]="'mb-2'"
        [expanded]="isAccordionExpanded"
        title="{{
          'URLs added to report' | translate: { count: reportUrls().length }
        }} "
      >
        <div class="d-flex justify-content-between mb-2">
          <upd-input-switch
            id="group"
            [text]="'Group pages as a segment' | translate"
            [checked]="isGrouped()"
            (checkedChange)="setIsGrouped($event); resetValidation()"
          >
          </upd-input-switch>
          <div>
            <button
              id="copy_url"
              cdkCopyToClipboard="{{ reportUrls().join('\n') }}"
              [cdkCopyToClipboardAttempts]="5"
              class="btn btn-outline-primary btn-sm me-2"
              (click)="copyToClipboard()"
            >
              <span class="material-icons" aria-hidden="true"
                >content_copy</span
              >
              <span [translate]="'copy-all'"></span>
            </button>
            <button class="btn btn-outline-danger btn-sm" (click)="resetUrls()">
              <span class="material-icons" aria-hidden="true">close</span>
              <span [translate]="'remove-all'"></span>
            </button>
          </div>
        </div>
        <p-table
          [value]="reportUrls()"
          styleClass="p-datatable-striped"
          class="urls-added-table w-100"
          [styleClass]="'p-datatable-sm'"
        >
          <ng-template pTemplate="body" let-url let-rowIndex="rowIndex">
            <tr>
              <td>
                <a
                  href="{{ 'https://' + url }}"
                  (click)="openLink($event, 'https://' + url)"
                  class="p-1 align-text-top"
                  >{{ url }}</a
                >
              </td>
              <td>
                <button
                  type="button"
                  class="mt-1 me-1 rounded p-0 btn btn-light"
                  aria-label="Remove"
                  (click)="removePage(rowIndex); resetValidation()"
                >
                  <span aria-hidden="true" class="material-icons text-danger"
                    >close</span
                  >
                </button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </upd-accordion>
    </div>
  </div>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col-12">
      <!-- <div *ngIf="validationTriggered && !areMetricsValid()">
        <upd-alert
          [type]="'danger'"
          [dismissible]="false"
          [selfClosing]="false"
        >
          <span class="material-icons align-top pe-1" aria-hidden="true"
            >error</span
          >
          <span [translate]="'alert-metric'"></span>
        </upd-alert>
      </div> -->
      <h3 class="mb-2 h5 pt-2 pb-2" id="select-metric">
        {{ 'select-metric' | translate }}
        <span class="required-star"></span>
      </h3>

      <upd-checkbox
        [id]="'metrics'"
        [items]="reportMetrics"
        [selectedItems]="stateMetrics"
        [invalid]="validationTriggered && !areMetricsValid()"
        (selectedItemsChange)="selectMetrics($event); resetValidation()"
      >
      </upd-checkbox>
    </div>
  </div>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col-12">
      <h3 class="mb-2 h5 pt-2 pb-2 card-tooltip">
        <span placement="top" ngbTooltip="{{'tooltip-select-dimension' | translate}}">{{
          'select-dimension' | translate
        }}</span>
        </h3>

      <upd-radio
        [id]="'dimensions'"
        [items]="reportDimensions"
        [selectedItem]="stateDimension"
        (selectedItemsChange)="selectDimension($event.value); resetValidation()"
      ></upd-radio>
    </div>
  </div>
</div>

<div class="d-flex">
  <button
    class="btn btn-primary btn-generate-report"
    (click)="!isDateRangeValid(); createReport(config())"
  >
    <span [translate]="'generate-report'"></span>
    <span class="material-icons" aria-hidden="true">navigate_next</span>
  </button>
</div>

<upd-card styleClass="mt-3 d-inline-block">
  <code>
    <pre>{{ config() | json }}</pre>
  </code>
</upd-card>

<hr />
