<h3 class="mb-2 h5 pt-2 pb-2" [translate]="'select-granularity'"></h3>

<upd-dropdown
  id="granularity"
  [label]="selectedGranularity() || 'Select' | translate"
  [options]="granularityOptions"
  (selectOption)="selectGranularity($event); resetValidation()"
>
</upd-dropdown>

<ng-container *ngIf="showCopyAlert">
  <upd-alert position="top">Copied successfully!</upd-alert>
</ng-container>

<ng-container *ngIf="isGranularitySelected()">
  <h3 class="mb-2 h5 pt-2 pb-2" [translate]="'select-date'"></h3>

  <div *ngIf="validationTriggered && !isDateRangeValid()">
    <upd-alert [type]="'danger'" [dismissible]="false" [selfClosing]="false">
      <span class="material-icons align-top pe-1" aria-hidden="true"
        >error</span
      >
      <span [translate]="'alert-date'"></span>
    </upd-alert>
  </div>

  <upd-calendar
    #calendar
    [showAction]="true"
    [showPreset]="true"
    (dateChange)="handleDateChange($event); resetValidation()"
    [granularity]="selectedGranularity().value"
    [required]="false"
  ></upd-calendar>
</ng-container>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
      <h3 class="mb-2 h5 pt-2 pb-2" [translate]="'select-url'"></h3>

      <div *ngIf="validationTriggered && !areUrlsValid()">
        <upd-alert
          [type]="'danger'"
          [dismissible]="false"
          [selfClosing]="false"
        >
          <span class="material-icons align-top pe-1" aria-hidden="true"
            >error</span
          >
          <span [translate]="'alert-url'"></span>
        </upd-alert>
      </div>

      <div
        [title]="'Validation Results'"
        *ngIf="invalidUrls.length > 0 || reportUrls.length > 0"
      >
        <div *ngIf="reportUrls.length > 0">
          <upd-alert
            [type]="'success'"
            position="static"
            [dismissible]="true"
            [selfClosing]="true"
          >
            <span class="material-icons align-top pe-1" aria-hidden="true"
              >check</span
            >
            <span>Success URLs:</span>
            <ol>
              <li *ngFor="let url of newUrls()">{{ url }}</li>
            </ol>
          </upd-alert>
        </div>
        <div *ngIf="invalidUrls.length > 0">
          <upd-alert
            [type]="'danger'"
            [dismissible]="false"
            [selfClosing]="false"
            position="static"
          >
            <span class="material-icons align-top pe-1" aria-hidden="true"
              >error</span
            >
            <span>Invalid URLs:</span>
            <ul>
              <li *ngFor="let url of invalidUrls()">{{ url }}</li>
            </ul>
          </upd-alert>
        </div>
      </div>

      <div class="card add-pages-card">
        <p-tabView styleClass="tabview-custom">
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>Bulk Pages</span>
            </ng-template>
            <span class="p-float-label mt-3">
              <textarea
                pInputTextarea
                #urlTextarea
                rows="5"
                id="float-input"
                class="w-100"
              ></textarea>
              <label for="float-input"
                >Enter URLs separated by comma, semicolon or new lines</label
              >
            </span>
          </p-tabPanel>
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>Pages</span>
            </ng-template>
            <upd-data-table
              #dataTable
              id="pages-home-"
              [data]="pages()"
              [cols]="columns()"
              [displayRows]="5"
              [loading]="selectionData() === null"
              placeholderText="dt_search_keyword_url"
              [searchFields]="searchFields()"
              [exports]="false"
              [checkboxes]="true"
              (pageSelectionChanged)="selectPages($event)"
              [ngClass]="'pages-home'"
            >
            </upd-data-table>
          </p-tabPanel>
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>Tasks</span>
            </ng-template>
            <upd-data-table
              #tasksTable
              id="tasks-list-"
              [data]="tasks()"
              [cols]="taskColumns()"
              [displayRows]="5"
              [loading]="selectionData() === null"
              [exports]="false"
              [checkboxes]="true"
              (pageSelectionChanged)="selectTasks($event)"
              [ngClass]="'tasks-list'"
            >
            </upd-data-table>
          </p-tabPanel>
          <p-tabPanel>
            <ng-template pTemplate="header">
              <span>UX projects</span>
            </ng-template>
            <upd-data-table
              #projectsTable
              id="projects-list-"
              [data]="projects()"
              [cols]="taskColumns()"
              [displayRows]="5"
              [loading]="selectionData() === null"
              [exports]="false"
              [checkboxes]="true"
              (pageSelectionChanged)="selectProjects($event)"
              [ngClass]="'projects-list'"
            >
            </upd-data-table>
          </p-tabPanel>
        </p-tabView>

        <button
          class="btn btn-outline-primary"
          (click)="
            addPages(urlTextarea.value);
            resetTableSelection();
            resetValidation()
          "
        >
          Add page(s)
        </button>
      </div>
    </div>
  </div>
</div>
<div class="container-fluid my-4 gx-0" *ngIf="reportUrls().length > 0">
  <div class="row">
    <div class="col">
      <!--   ACCORDION IS DEPRECATED   -->
      <upd-accordion
        #urlsAdded
        [styleClass]="'mb-2'"
        [expanded]="isAccordionExpanded"
        title="{{
          'URLs added to report' | translate: { count: reportUrls().length }
        }} "
      >
        <div class="d-flex justify-content-between">
          <upd-input-switch
            id="group"
            [(checked)]="isGrouped()"
            [text]="'Group pages as a segment'"
            (checkedChange)="setIsGrouped($event); resetValidation()"
          >
          </upd-input-switch>
          <div>
            <button
              id="copy_url"
              cdkCopyToClipboard="{{ reportUrls().join('\n') }}"
              [cdkCopyToClipboardAttempts]="5"
              class="btn btn-outline-primary btn-sm me-2"
              (click)="copyToClipboard()"
            >
              <span class="material-icons" aria-hidden="true"
                >content_copy</span
              >
              <span [translate]="'copy-all'"></span>
            </button>
            <button class="btn btn-outline-danger btn-sm" (click)="resetUrls()">
              <span class="material-icons" aria-hidden="true">close</span>
              <span [translate]="'remove-all'"></span>
            </button>
          </div>
        </div>
        <div class="container">
          <div class="row">
            <div class="col p-0">
              <p-table
                [value]="reportUrls()"
                styleClass="p-datatable-striped"
                class="urls-added-table w-100"
              >
                <ng-template pTemplate="body" let-url let-rowIndex="rowIndex">
                  <tr>
                    <td>
                      <a
                        href="{{ 'https://' + url }}"
                        (click)="openLink($event, 'https://' + url)"
                        class="p-1 align-text-top"
                        placement="top"
                        >{{ url }}</a
                      >
                    </td>
                    <td>
                      <button
                        type="button"
                        class="btn-close btn-close-black mt-1 me-1"
                        aria-label="Close"
                        (click)="removePage(rowIndex); resetValidation()"
                      ></button>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </div>
        </div>
      </upd-accordion>
    </div>
  </div>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col-6">
      <div *ngIf="validationTriggered && !areMetricsValid()">
        <upd-alert
          [type]="'danger'"
          [dismissible]="false"
          [selfClosing]="false"
        >
          <span class="material-icons align-top pe-1" aria-hidden="true"
            >error</span
          >
          <span [translate]="'alert-metric'"></span>
        </upd-alert>
      </div>
      <h3 class="mb-2 h5 pt-2 pb-2" [translate]="'select-metric'"></h3>

      <upd-checkbox
        [id]="'metrics'"
        [items]="reportMetrics"
        [(selectedItems)]="selectedReportMetrics()"
        (selectedItemsChange)="selectMetrics($event); resetValidation()"
      >
      </upd-checkbox>
    </div>
  </div>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col-6">
      <h3 class="mb-2 h5 pt-2 pb-2">Select a dimension for breakdown:</h3>

      <upd-radio
        [id]="'dimensions'"
        [items]="reportDimensions"
        [(selectedItems)]="selectedReportDimensions()"
        (selectedItemsChange)="selectDimension($event); resetValidation()"
      >
      </upd-radio>
    </div>
  </div>
</div>

<div class="d-flex">
  <button
    class="btn btn-primary btn-generate-report"
    (click)="!isDateRangeValid(); createReport(config())"
  >
    <span [translate]="'generate-report'"></span>
    <span class="material-icons" aria-hidden="true">navigate_next</span>
  </button>
</div>

<hr />
