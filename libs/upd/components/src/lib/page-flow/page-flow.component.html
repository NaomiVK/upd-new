<ng-template #itemTemplate let-page="page">
  <div class="d-flex flex-column h-100 w-100 pointer">
    <div class="title mt-1">
      <div>{{ page?.title || page.url }}</div>
    </div>

    <div class="d-flex mt-2">
      <strong>{{ page.visits | number }}</strong>
      @if (page !== focusPage()) {
        &nbsp;({{ page.visits / focusPage().visits | percent: '1.0-1' }})
      }
    </div>

    <div class="d-flex justify-content-between align-items-center gap-2 mt-3">
      @if (page === focusPage()) {
        <!-- Center the Focus badge -->
        <span class="badge bg-dark">Focus</span>
      } @else if (page.rank && page.entries) {
        <!-- Left-align the Rank badge with entries -->
        <span class="badge bg-warning text-dark">Rank {{ page.rank }}</span>
      } @else if (page.rank && page.exits) {
        <!-- Right-align the Rank badge with exits -->
        <span class="badge" style="background: #1976d2"
          >Rank {{ page.rank }}</span
        >
      } @else {
        <!-- Default case for Rank with a placeholder -->
        <div class="badge badge-empty">Rank ?</div>
      }
    </div>

    <div
      class="d-flex justify-content-between align-items-center gap-2 mt-auto mb-2"
    >
      @if (page.entries) {
        <span class="badge bg-success w-100" aria-describedby="entriesTooltip"
          >Entries: {{ page?.entries / page?.visits | percent: '1.0-1' }}</span
        >
      }

      @if (page.exits) {
        <span class="badge bg-danger w-100" aria-describedby="exitsTooltip"
          >Exits: {{ page?.exits / page?.visits | percent: '1.0-1' }}</span
        >
      }

      @if (!page.entries && !page.exits) {
        <span class="badge badge-empty w-100"></span>
      }
    </div>
  </div>
</ng-template>

<ng-template #topPreviousTooltip>
  @if (previousPages().length === 0 && previousOptions().length > 0) {
    <p>
      The list below consists of the top pages that users visited prior to the
      focus page <strong>{{ focusPage().title || focusPage().url }}</strong>
    </p>
  } @else if (previousPages().length > 0) {
    <p>
      The list below consists of the top pages that users visited prior to the
      page
      <strong>{{ selectedFlow()[0].title || selectedFlow()[0].url }}</strong
      >, following the existing page flow to the focus page
      <strong>{{ focusPage().title || focusPage().url }}</strong>
    </p>
  }
</ng-template>

<ng-template #topNextTooltip>
  @if (nextPages().length === 0 && nextOptions().length > 0) {
    <p>
      The list below consists of the top pages that users visited following from
      the focus page <strong>{{ focusPage().title || focusPage().url }}</strong>
    </p>
  } @else if (nextPages().length > 0) {
    <p>
      The list below consists of the top pages that users visited following the
      focus page <strong>{{ focusPage().title || focusPage().url }}</strong
      >, following the existing page flow to the page
      <strong>{{
        selectedFlow()[selectedFlow().length - 1].title ||
          selectedFlow()[selectedFlow().length - 1].url
      }}</strong>
    </p>
  }
</ng-template>

<div class="container-fluid my-4 gx-0">
  <upd-card [title]="title()" [modal]="modal()" [modalSize]="modalSize()">
    <!-- <upd-arrow-connect
      [visible]="!isLoadingPrevious"
      [update]="!isLoadingNext"
      [source]="sourcePreviousFlow()"
      [target]="targetPreviousFlow()"
      class="flow-arrow"
    ></upd-arrow-connect>

    <upd-arrow-connect
      [visible]="!isLoadingNext"
      [update]="!isLoadingPrevious"
      [source]="sourceNextFlow()"
      [target]="targetNextFlow()"
      class="flow-arrow"
    ></upd-arrow-connect> -->

    <div class="row">
      @if (isInit()) {
        <div class="loading-overlay">
          <div class="loading-spinner" aria-live="polite"></div>
        </div>
      } @else {
        <!-- Current Flow Section -->
        <div class="col-lg-12 col-md-12 col-sm-12 flow-container">
          @if (totalPages() !== 4) {
            <!-- Select previous top page -->
            <div
              id="targetPreviousFlow"
              class="flow-item current-flow inactive selected-previous-flow-item"
              tabindex="0"
            >
              Select previous page listed below
            </div>

            <div class="material-icons">chevron_right</div>
          }

          <!-- Flow items (dynamic items generated in a loop) -->
          @for (page of selectedFlow(); track page.url) {
            <ng-template #tooltip>
              @if (page?.title) {
                <strong class="my-1">{{ page.title }}</strong> <br />
              }
              {{ page.url }}
              <span class="d-block mt-2 my-1">
                @if (page === focusPage()) {
                  <strong>{{ page.visits | number }} total visits</strong>
                } @else {
                  <strong>{{ page.visits | number }} visits </strong> ({{
                    page.visits / focusPage().visits | percent: '1.0-1'
                  }})
                }
              </span>
              @if (page === focusPage()) {
                <span class="my-1 d-block"><strong>Rank:</strong> Focus </span>
              }
              @if (page.rank) {
                <span class="my-1 d-block"
                  ><strong>Rank:</strong> {{ page.rank }}</span
                >
              }
              @if (page.entries) {
                <span class="my-1 d-block">
                  <strong>Entries:</strong>
                  {{ page.entries | number }} ({{
                    page.entries / page.visits | percent: '1.0-1'
                  }})
                </span>
              }
              @if (page.exits) {
                <span class="my-1 d-block">
                  <strong>Exits:</strong>
                  {{ page.exits | number }} ({{
                    page.exits / page.visits | percent: '1.0-1'
                  }})
                </span>
              }
            </ng-template>
            <div
              class="flow-item current-flow flow-tooltip"
              [ngbTooltip]="tooltip"
              [tooltipClass]="'flow-tooltip'"
              placement="top"
              [ngClass]="{ 'focal-url': page === focusPage() }"
              tabindex="0"
            >
              <ng-container
                *ngTemplateOutlet="itemTemplate; context: { page }"
              ></ng-container>
            </div>

            @if (!$last) {
              <div class="material-icons">chevron_right</div>
            }
          }

          @if (totalPages() !== 4) {
            <div class="material-icons">chevron_right</div>

            <!-- Select next page -->
            <div
              id="sourceNextFlow"
              class="flow-item current-flow selected-next-flow-item inactive"
              tabindex="0"
            >
              Select next page listed below
            </div>
          }
        </div>

        @if (totalPages() === 4) {
          <upd-alert [type]="'danger'" [dismissible]="false">
            Youâ€™ve reached the maximum number of pages to be
            displayed.</upd-alert
          >
        }

        <!-- Previous Pages Section -->
        <div class="col-lg-6 col-md-12 col-sm-12">
          <div class="d-flex align-items-center mb-2">
            <strong
              class="card-tooltip me-2"
              [ngbTooltip]="topPreviousTooltip"
              aria-describedby="topPreviousTooltip"
              >Previous top pages visited</strong
            >

            @if (isLoadingPrevious || previousPages().length === 0) {
              <button
                class="btn btn-sm d-flex align-items-center"
                role="button"
                disabled
              >
                <span class="material-icons me-1" aria-hidden="true"
                  >refresh</span
                >
                Reset
              </button>
            } @else {
              <button
                class="btn btn-sm d-flex align-items-center"
                (click)="resetPageFlowData('previous')"
              >
                <span class="material-icons me-1" aria-hidden="true"
                  >refresh</span
                >
                Reset
              </button>
            }
          </div>
          @if (previousOptions().length > 0 && !isLoadingPrevious) {
            <div class="flow-wrapper">
              @for (page of previousOptions(); track page.url) {
                <ng-template #tooltip>
                  @if (page?.title) {
                    <strong>{{ page.title }}</strong> <br />
                  }
                  {{ page.url }} <br />
                  <span class="item-data"
                    ><strong>{{ page.visits | number }}</strong> ({{
                      page.visits / focusPage().visits | percent: '1.0-1'
                    }})</span
                  >
                </ng-template>
                @if (totalPages() === 4) {
                  <div
                    #sourcePreviousFlow
                    class="flow-item previous-flow-item flow-item-selectable d-flex justify-content-between align-items-center disabled"
                    [ngClass]="{ 'prev-first-item': $first }"
                    [ngbTooltip]="tooltip"
                    placement="left top"
                  >
                    <!-- Left section (Badge and Title) -->
                    <div class="d-flex align-items-center">
                      <span class="badge bg-warning text-dark me-2">{{
                        $index + 1
                      }}</span>
                      <span *ngIf="!isLoadingPrevious">{{
                        page?.title || page.url
                      }}</span>
                    </div>

                    <!-- Right section (Visits and Percentage) -->
                    <div class="text-end text-nowrap">
                      <strong>{{ page.visits | number }}</strong>
                      ({{
                        page.visits / focusPage().visits | percent: '1.0-1'
                      }})
                    </div>
                  </div>
                } @else {
                  <div
                    #sourcePreviousFlow
                    class="flow-item previous-flow-item flow-item-selectable d-flex justify-content-between align-items-center pointer"
                    [ngClass]="{ 'prev-first-item': $first }"
                    [ngbTooltip]="tooltip"
                    placement="left top"
                    (click)="pageClick('previous', 5, page, $index + 1)"
                    (keydown)="
                      handleKeyDown($event, 'previous', 5, page, $index + 1)
                    "
                    tabindex="0"
                  >
                    <!-- Left section (Badge and Title) -->
                    <div class="d-flex align-items-center">
                      <span class="badge bg-warning text-dark me-2">{{
                        $index + 1
                      }}</span>
                      <span *ngIf="!isLoadingPrevious">{{
                        page?.title || page.url
                      }}</span>
                    </div>

                    <!-- Right section (Visits and Percentage) -->
                    <div class="text-end text-nowrap">
                      <strong>{{ page.visits | number }}</strong>
                      ({{
                        page.visits / focusPage().visits | percent: '1.0-1'
                      }})
                    </div>
                  </div>
                }
              }
            </div>
            <div
              class="flow-item flow-item-selectable pointer"
              *ngIf="!(previousOptions().length % 5)"
              (click)="pageClick('previous', previousOptions().length + 5)"
              (keydown)="
                handleKeyDown($event, 'previous', previousOptions().length + 5)
              "
              tabindex="0"
              aria-label="Load more previous pages"
            >
              <div class="d-flex align-items-center">Load more</div>
            </div>
          } @else {
            @if (!isLoadingPrevious && previousPages().length === 0) {
              <div
                class="flow-item"
                (click)="resetPageFlowData('previous')"
                tabindex="0"
                aria-label="Load previous pages"
              >
                <p>Load previous pages</p>
              </div>
            } @else if (!isLoadingPrevious && previousPages().length > 0) {
              <div class="flow-item" tabindex="0" aria-label="No more results">
                <p>No more results</p>
              </div>
            } @else {
              <div tabindex="0" aria-label="Loading previous pages">
                <p>Loading...</p>
              </div>
            }
          }
        </div>

        <!-- Next Pages Section -->
        <div class="col-lg-6 col-md-12 col-sm-12">
          <div class="d-flex align-items-center mb-2">
            <strong
              class="card-tooltip me-2"
              [ngbTooltip]="topNextTooltip"
              aria-describedby="topNextTooltip"
              >Next top pages visited</strong
            >
            @if (isLoadingNext || nextPages().length === 0) {
              <button
                class="btn btn-sm d-flex align-items-center"
                role="button"
                disabled
              >
                <span class="material-icons me-1" aria-hidden="true"
                  >refresh</span
                >
                Reset
              </button>
            } @else {
              <button
                class="btn btn-sm d-flex align-items-center"
                (click)="resetPageFlowData('next')"
              >
                <span class="material-icons me-1" aria-hidden="true"
                  >refresh</span
                >
                Reset
              </button>
            }
          </div>
          @if (nextOptions().length > 0 && !isLoadingNext) {
            <div class="flow-wrapper">
              @for (page of nextOptions(); track page.url) {
                <ng-template #tooltip>
                  @if (page?.title) {
                    <strong>{{ page.title }}</strong> <br />
                  }
                  {{ page.url }} <br />
                  <span class="item-data"
                    ><strong>{{ page.visits | number }}</strong> ({{
                      page.visits / focusPage().visits | percent: '1.0-1'
                    }})</span
                  >
                </ng-template>
                @if (totalPages() === 4) {
                  <div
                    #targetNextFlow
                    class="flow-item next-flow-item flow-item-selectable d-flex justify-content-between align-items-center disabled"
                    [ngClass]="{ 'next-first-item': $first }"
                    [ngbTooltip]="tooltip"
                    placement="right top"
                  >
                    <!-- Left section (Badge and Title) -->
                    <div class="d-flex align-items-center">
                      <span
                        class="badge me-2"
                        [style]="'background: #1976D2'"
                        >{{ $index + 1 }}</span
                      >
                      <span *ngIf="!isLoadingNext">{{
                        page?.title || page.url
                      }}</span>
                    </div>

                    <!-- Right section (Visits and Percentage) -->
                    <div class="text-end text-nowrap">
                      <strong>{{ page.visits | number }}</strong>
                      ({{
                        page.visits / focusPage().visits | percent: '1.0-1'
                      }})
                    </div>
                  </div>
                } @else {
                  <div
                    #targetNextFlow
                    class="flow-item next-flow-item flow-item-selectable d-flex justify-content-between align-items-center pointer"
                    [ngClass]="{ 'next-first-item': $first }"
                    [ngbTooltip]="tooltip"
                    placement="right top"
                    (click)="pageClick('next', 5, page, $index + 1)"
                    (keydown)="
                      handleKeyDown($event, 'next', 5, page, $index + 1)
                    "
                    tabindex="0"
                  >
                    <!-- Left section (Badge and Title) -->
                    <div class="d-flex align-items-center">
                      <span
                        class="badge me-2"
                        [style]="'background: #1976D2'"
                        >{{ $index + 1 }}</span
                      >
                      <span *ngIf="!isLoadingNext">{{
                        page?.title || page.url
                      }}</span>
                    </div>

                    <!-- Right section (Visits and Percentage) -->
                    <div class="text-end text-nowrap">
                      <strong>{{ page.visits | number }}</strong>
                      ({{
                        page.visits / focusPage().visits | percent: '1.0-1'
                      }})
                    </div>
                  </div>
                }
              }
            </div>
            <div
              class="flow-item flow-item-selectable pointer"
              *ngIf="!(nextOptions().length % 5)"
              (click)="pageClick('next', nextOptions().length + 5)"
              (keydown)="
                handleKeyDown($event, 'next', nextOptions().length + 5)
              "
              tabindex="0"
              aria-label="Load more next pages"
            >
              <div class="d-flex align-items-center">Load more</div>
            </div>
          } @else {
            @if (!isLoadingNext && nextPages().length === 0) {
              <div
                class="flow-item"
                (click)="resetPageFlowData('next')"
                tabindex="0"
                aria-label="Load next pages"
              >
                <p>Load next pages</p>
              </div>
            } @else if (!isLoadingNext && nextPages().length > 0) {
              <div class="flow-item" tabindex="0" aria-label="No more results">
                <p>No more results</p>
              </div>
            } @else {
              <div tabindex="0" aria-label="Loading next pages">
                <p>Loading...</p>
              </div>
            }
          }
        </div>
      }
    </div>

    <div class="pt-3">
      <upd-accordion>
        <upd-data-table
          [data]="selectedFlow()"
          [cols]="currentFlowCols"
        ></upd-data-table>
      </upd-accordion>
    </div>
  </upd-card>
</div>
